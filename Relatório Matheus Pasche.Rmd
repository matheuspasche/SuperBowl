---
title: "Cumbuca Case"
author: "Matheus Pasche"
date: "29/05/2022"
output:
  pdf_document:
    latex_engine: xelatex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, out.width = '90%')
library(testthat)
library(tidyverse)
library(lubridate)
library(pilot) #remotes::install_github("olihawkins/pilot")
library(knitr)

```


## DNA

O Rbase contém uma função relativamente pouco utilizada, mas poderosa para traduções simples: chartr

```{r cars}
#' nucleotides
#' Esta função traduz DNA para RNA
#' @param dna character com nucleotideos
#'
#' @return 
#' @export
#'
#' @examples
#' nucleotides("CGAT")
nucleotides <- function(dna) {
  
if(!is.character(dna)){stop("Please insert character nucleotides, such as ACGT")}

  old <- "GCTA"
  new <- "CGAU"
  
  translate <- chartr(
    old = old,
    new = new,
    x = dna
  ) 
  
  return(translate)
}

##
test_that("Translate dna", {
  expect_equal(nucleotides("GACATGG"), "CUGUACC")
  expect_equal(nucleotides("AAATTT"), "UUUAAA")
  expect_error(nucleotides(1234))
})
```

## NycFlights

É possível identificar que o dataframe possui alguns voos sem informação sobre partida e chegada. Como representam menos de 3\% dos registros, optarei por eliminar a fim de evitar problemas.

```{r}
flights <- nycflights13::flights %>% 
  mutate(total_delay = arr_delay + dep_delay, month_year = floor_date(time_hour, 'month'),
         time = as_date(time_hour),
         month_year = ym(paste0(year, month)),
         status = case_when(total_delay > 0 ~ 'delay', total_delay <0~ 'early', total_delay ==0 ~'in time'))

flights %>%
    summarise(across(everything(), ~ sum(is.na(.)))) %>% 
    pivot_longer(cols = everything(), names_to = 'Variable',values_to = 'NA Count') %>% 
    knitr::kable(caption = 'Contagem de NAs')

```

### Questão 1:

A quantidade total de voos, que inclui atrasados e não atrasados, não variou consideravelmente ao longo dos meses. 

```{r}

flights %>% 
  filter(!is.na(status)) %>% 
  janitor::tabyl(month, status) %>% 
  janitor::adorn_totals(where = 'col') %>% 
  kable(caption = "Quantidade de voos por mês e status",
        format.args = list(big.mark = ".",decimal.mark = ","))
```

Tendo em vista que estamos interessados em analisar o atraso, foram retirados os voos com saldo total (embarque + desembarque) negativo. Abaixo podemos identificar os primeiros registros do atraso médio, mediano e estatísticas percentuais para cada dia do ano. Evidentemente não é prático exibir todos os 365 dias. 

```{r}
stats <- function(.data, variable) {
      .data %>%
           summarise(
                  count = n(),
                  mean = mean({{variable}}),
                  median = median({{variable}}),
                  sd = sd({{variable}}),
                  var = var({{variable}}),
                  'p.01'=quantile({{variable}}, probs = .1),
                  'p.025'=quantile({{variable}}, probs = .25),
                  'p.09'=quantile({{variable}}, probs = .9),
                  'p.99'=quantile({{variable}}, probs = .99)
                  )
                        
}

flights %>%
    filter(!is.na(air_time), status == 'delay') %>% 
    with_groups(time, ~stats(., variable = total_delay))%>%
    head() %>% 
    knitr::kable(caption = 'Registros de estatísticas descriticas por dia', digits=1)
    
```

Para fins de análise do desempenho e tendo em vista que em um único dia há registro de vários voos, agregaremos os dados em meses. Inicialmente podemos verificar que os períodos de maior atraso mediano são junho-julho e dezembro.

```{r}
flights %>% 
  filter(!is.na(air_time), status == 'delay') %>% 
  with_groups(month, ~stats(., variable = total_delay)) %>% 
  knitr::kable(caption = 'Registros de estatísticas descriticas por mês', digits=1)

```

Tendo em vista que a quantidade total de voos no mês tende a se manter constante, o que poderia explicar que a quantidade de minutos de atraso médio em julho pode ser aproximadamente o dobro do observado em novembro? A explicação mais imediata com base em senso comum é a sazonalidade dos feriados e período de férias. Os meses de junho a agosto marcam as férias de verão dos colégios e universidades, enquanto o mês de dezembro é o período de reuniões familiares para as festas de fim de ano. 

```{r}
lateDay %>%
  mutate(month = format(time, '%m-%y')) %>% 
  ggplot(aes(x = month, y= mean, fill = month))+
  geom_boxplot(show.legend = F)+
  pilot::scale_fill_pilot()+
  pilot::theme_pilot()+
  labs(title = 'Media dos atrasos por mes', y = 'Media', x = 'Mes')
  
```
 
O maior atraso nesses meses pode ser explicado em partes pela maior quantidade de voos. Uma vez que estamos observando apenas os voos com atraso, é evidente que um número maior de voos tende a causar um número maior de atrasos, seja porque estamos realizando o experimento o evento mais vezes, seja por um aumento das atribuições das equipes nos meses de pico.

```{r}
flights %>% 
  filter(!is.na(air_time), status == 'delay') %>% 
  group_by(month, day) %>% 
  summarise(mean = mean(total_delay), count = n()) %>% 
  ggplot(aes(x = count, y = mean))+
  geom_point(col = pilot::pilot_color(2))+
  geom_smooth(method="lm", formula= (y ~ x), se=FALSE, col = pilot::pilot_color(1) )+
  pilot::theme_pilot()+
  labs(title = 'Media dos atrasos por mes', y = 'Média dos minutos', x = 'Mes')

  

```

### Questão 2: 

Ao observar 

```{r}
airlines <- nycflights13::airlines

flights <- flights %>% left_join(airlines)


Companies = flights %>% 
  filter(!is.na(air_time)) %>% 
  with_groups(c(name,status), ~summarise(.,count = n())) %>%
  with_groups(name, ~mutate(., Razao = count/sum(count)))
  
Companies %>% 
  mutate(Abovefifty = case_when (Razao >= .5 ~ 'Mais de 50% de atrasos',TRUE~ 'Menos de 50% de atrasos')) %>% 
  filter(status == 'delay') %>% 
  ggplot(aes(x = Razao, y = reorder(name, Razao), fill = Abovefifty))+
  geom_bar(stat = 'identity')+
  geom_text(aes(label = scales::percent(Razao)), hjust = 1)+
  pilot::scale_fill_pilot()+
  pilot::theme_pilot()+
  labs(title = 'Empresas com mais de 50% dos voos atrasados', x= '% dos voos atrasados', y= 'Empresas')
```


```{r}
Companies %>% 
  filter(status == 'delay') %>% 
  mutate(Razao = count/sum(count),
         Abovefifteen = case_when (Razao >= .15 ~ 'Mais de 15% de atrasos',TRUE~ 'Menos de 15% de atrasos')) %>% 
  ggplot(aes(x = Razao, y = reorder(name, Razao), fill = Abovefifteen))+
  geom_bar(stat = 'identity')+
  pilot::scale_fill_pilot()
```

